/**! 
* Masked - v1.1.0 - 
* 
* @author Rashin Sergey 
* @version 1.1.0 2017-04-10
*/
var Global={languages:[],countries:{all:[],ae:[],an:[],ba:[],bt:[],ca:[],cn:[],de:[],ec:[],ee:[],id:[],il:[],jp:[],kp:[],la:[],lb:[],ly:[],mc:[],mm:[],mx:[],my:[],ng:[],nz:[],ru:[],sa:[],sb:[],so:[],sr:[],th:[],tl:[],tv:[],tw:[],ua:[],us:[],vn:[],vu:[],ye:[]}},$M=MaskedReady=function(){return function(a){this.use=!0,a(),MaskEventBroker.publish("initialization")}}();$M.ready=$M;var alternativeReady=function(){return{timerID:0,init:function(){this.timerID&&clearTimeout(this.timerID),this.timerID=setTimeout(function(){MaskEventBroker.publish("initialization"),MaskEvents.events.initialized=!0},250)}}}(),generalMaskedFn={extend:function(a,b){var c,d={},e=Object.prototype.hasOwnProperty;for(c in a)a.hasOwnProperty(c)&&e.call(a,c)&&(d[c]=a[c]);for(c in b)b.hasOwnProperty(c)&&e.call(b,c)&&(d[c]=b[c]);return d},addLanguage:function(a){-1===Global.languages.indexOf(a)&&Global.languages.push(a)}},MaskedConfig=MConf=function(){var a={ru:{localFormat:"8",exceptions:{8975:"7975"}}},b={pathToList:"/js/masks/",prefix:"instId_",language:"ru",country:"ru",one_country:!1,country_call_binding:!1,first_countries:["ru"],exceptions:a,initial_focus:!1,select_range:!1,onToggleList:null,onShowList:null,onHideList:null,onSend:null,onValueChanged:null,onTitleChanged:null,popup_direction:"auto"};return function(a){if("string"==typeof a)return b[a];for(var c in a)a.hasOwnProperty(c)&&void 0===b[c]&&console.warn("masked argument not exists");return b=generalMaskedFn.extend(b,a)}}(),MaskEvents=function(){function a(){this.events={initialized:!1,maskListLoaded:!1,createdMaskObjects:!1},this.oldstate={};for(var a in this.events)this.events.hasOwnProperty(a)&&(this.oldstate[a]=[])}var b=function(a,b){var c=this,d=c.events,e=c.oldstate;d.hasOwnProperty(a)&&e[a].push(setInterval(function(){var c=!1,f=d[a];if("boolean"==typeof f&&(!0===f&&-1===e[a].indexOf("clear")&&(console.info("event: ",a),c=!0,b()),c))for(var g in e[a])e[a].hasOwnProperty(g)&&(clearInterval(e[a][g]),e[a][g]="clear")},50))};return a.prototype={onInitialized:function(a){return b.call(this,"initialized",a)},onMaskListLoaded:function(a){return b.call(this,"maskListLoaded",a)},onCreatedMaskObjects:function(a){return b.call(this,"createdMaskObjects",a)}},new a}(),MaskEventBroker=function(){function a(){this.subjects=[]}return a.prototype={subscribe:function(a,b){this.get(a).push(b)},create:function(a){this.subjects[a]=[]},get:function(a){if(!this.has(a))throw new Error("Subject Not Found: "+a);return this.subjects[a]},has:function(a){return this.subjects.hasOwnProperty(a)},publish:function(a,b){var c=this.get(a),d=Array.prototype.slice.call(arguments,1);d.splice(0,0,null);for(var e=-1,f=c.length;++e<f;)setTimeout(Function.prototype.bind.apply(c[e],d),0);return"function"==typeof b&&b()}},new a}(),Masked=function(a,b){function c(a){return"function"==typeof a}function d(a){var b,c,d,e=[];if("string"==typeof a)if(d=a[0],"."!==d&&"#"!==d||(a=a.substr(1)),"."===d){c=document.getElementsByClassName(a);for(b in c)c.hasOwnProperty(b)&&"null"!==c[b]&&(e[c[b].id||b]=c[b])}else"#"===d?"null"!==(c=document.getElementById(a))&&e.push(c):console.warn("selector finder empty");else a.nodeType&&"null"!==a&&e.push(a);return e}function e(a){for(var b=a,c=[];null!==b.parentNode;){for(var d=0,e=0,f=b.parentNode.childNodes,g=0;g<f.length;g++){var h=f[g];h.nodeName===b.nodeName&&(h===b&&(e=d),d++)}var i=b.nodeName.toUpperCase();"CBH-masks"!==b.className?(c.unshift(d>1?i+"["+e+"]":i),b=b.parentNode,11===b.nodeType&&(b=b.host)):b=b.parentNode}return"//"+c.join("/")}function f(){for(var a=arguments,b=a.length,c=0,d=void 0,e=""+d;c!==b;){if(a[c]===d||typeof a[c]===e||null===a[c])return!1;c++}return!0}function g(){for(var a=arguments,b=a.length,c=0,d=0,e=void 0,f=""+e,g=[e,!1,""],h=g.length;c!==b;){for(d=0;d<h;d++)if(typeof a[c]===f||a[c]===g[d]||0===a[c].length)return!0;c++}return!1}function h(a){return(a+"").replace(/\D+/g,"")}var i=new RegExp("[0-9]"),j=(new RegExp([i.source].concat("_").join("|"),"g"),function(a){var b,c,d,e,h,i,j,k={},l=["GET","POST","PUT"],m=["json","text"],n={},o=XMLHttpRequest,p="Msxml2.XMLHTTP",q={url:a.url||!1,async:a.async||!1,data:a.data||null,crossDomain:a.crossDomain||!1,complete:a.result||function(){},timeout:a.timeout||1e4,type:(-1!==l.indexOf(a.type)?a.type:null)||"GET",dataType:(-1!==m.indexOf(a.dataType)?a.dataType:null)||"json"},r=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")};if(!g(q.url)){if(void 0===o&&(o=function(){try{var a=ActiveXObject}catch(a){}try{return new a(p+".6.0")}catch(a){}try{return new a(p+".3.0")}catch(a){}try{return new a(p)}catch(a){}throw new Error("This browser does not support XMLHttpRequest.")}),e=new("onload"in new o?o:XDomainRequest),d=q.url,"string"==typeof q.data)try{q.data=JSON.parse(q.data)}catch(a){}"object"==typeof q.data&&(q.data=r(q.data)),"GET"===q.type&&q.data&&q.data.length>0&&(d=q.url+"?"+q.data.toString()),e.open(q.type,d,q.async),q.crossDomain||(n["X-Requested-With"]="XMLHttpRequest");for(b in n)n.hasOwnProperty(b)&&f(n[b])&&e.setRequestHeader(b,n[b]+"");q.data&&q.data.toString().length>0&&(e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),q.data=q.data.toString());try{e.send(q.data||null)}catch(a){}if(q.async)var s=setTimeout(function(){e.abort()},q.timeout);j=function(){if(4===e.readyState)if(q.async&&clearTimeout(s),j="undefined",4!==e.readyState)e.abort();else{h=e.status,"string"==typeof e.responseText&&(k.text=e.responseText);try{i=e.statusText}catch(a){i=""}h||q.crossDomain?1223===h&&(h=204):h=k.text?200:404}if(k&&(h||q.crossDomain?1223===h&&(h=204):h=k.text?200:404,200===h)){if("text"===q.dataType)c=k.text||"";else if("json"===q.dataType)try{c=JSON.parse(k.text)||""}catch(a){c=""}q.complete(c,h,i,e.getAllResponseHeaders())}},q.async?4===e.readyState?setTimeout(j,20):e.onreadystatechange=j:j()}}),k={sortPhones:function(a,b,c){var d="mask",e="desc",g="asc",h=b===d?d:"name",i=c===e?e:g;return a&&a.sort(function(a,b){return f(a[h])&&f(b[h])?(h===d?(a=a[h].replace(/\D+/g,""),b=b[h].replace(/\D+/g,"")):(a=a[h],b=b[h]),a>b?i==g?1:-1:a<b?i==g?-1:1:0):f(a[h])?-1:1}),a},loadMask:function(a,b,d){var e=this,f=Global.countries,h="string"==typeof a?[a]:a.splice(0,1)[0],i="string"==typeof b?[b]:b.splice(0,1)[0];if(void 0===h&&void 0===i)return d();if(void 0!==h&&void 0===f[h])return e.loadMask(a,b,d);if(void 0!==f[h][i]&&f[h][i].length>0){if(0===b.length)return d();e.loadMask(a,b,d)}else j({url:MConf("pathToList")+h+"/"+(g(i)?"ru":i)+".min.json",type:"GET",async:!0,crossDomain:!0,dataType:"json",result:function(g){if(f[h][i]=e.sortPhones(g,"mask","desc"),0===b.length&&c(d))return d();e.loadMask(a,b,d)}});return!0}};MaskEventBroker.create("find.mask");var l=function(a,b){var c=this,d=c.options={xpath:!1,element:a,language:b.language||MConf("language"),country:b.country||MConf("country"),phone:b.phone||!1};a&&(d.oldState=a,a.value=d.phone||"",MaskEvents.onCreatedMaskObjects(function(){MaskEventBroker.publish("find.mask")}),MaskEventBroker.subscribe("find.mask",function(){c.findMask(d.phone)}),d.xpath=e(d.element))};l.prototype={findMask:function(a){var b=this,c=b.options,d=(c.one_country,c.language),e=c.country,f=h(a);c.exceptions;b.hardSearch(f,d,e)},hardSearch:function(a,b,c){var d,e,h,j,l,m,n,o=[],p=k,q=Global.countries.all[b];if(q=Global.countries.all[b],g(q))return!1;q=p.sortPhones(q,"mask","desc"),f(Global.countries[c])&&!g(Global.countries[c][b])&&(q=Global.countries[c][b].concat(q));for(d in q)if(q.hasOwnProperty(d)){for(m=q[d].mask,n=!0,e=0,h=0;e<a.length&&h<m.length;){var r=m.charAt(h),s=a.charAt(e);if(i.test(r)||"_"===r){if(!("_"===r&&i.test(s)||s==r)){n=!1;break}e++,h++}else h++}if(n&&e==a.length){if(-1==m.substr(h).search(i),m=m.replace(i,"_"),"1"===a&&"us"!==q[d].iso_code)continue;o.push(q[d])}}o=k.sortPhones(o,"mask","desc"),l=!1;for(d in o)o.hasOwnProperty(d)&&(j=o[d].mask.replace(/\D+/g,""),parseInt(j)===parseInt(a)&&(l=o[d]));if(l)return l;if(o.length>1&&o.sort(function(a,b){return Math.sign((a.mask.match(/_/g)||[]).length-(b.mask.match(/_/g)||[]).length)}),f(Global.countries[c])&&g(Global.countries[c][b])&&o&&a)for(d in o)if(o.hasOwnProperty(d)){var t=o[d].iso_code;"ca"===t&&(t="us"),console.log(o),MaskEventBroker.subscribe("load.all.masks.lists",function(){k.loadMask("all",Global.languages,function(){MaskEvents.events.maskListLoaded=!0})})}},setValue:function(a){var b=this,c=b.options;c.phone=a,c.element.placeholder=a,c.element.value=a}},MaskEventBroker.create("initialization"),MaskEventBroker.create("load.all.masks.lists"),MaskEventBroker.create("create.mask.objects");var m=function(a){MaskEvents.events.initialized=!1,MaskEvents.events.maskListLoaded=!1,MaskEvents.events.createdMaskObjects=!1,this.init(a),void 0===MaskedReady.use&&alternativeReady.init()};return m.prototype={init:function(a){var b,c,e=this;return a&&("string"==typeof a&&(a={selector:a}),c=generalMaskedFn.extend(MConf(),a)),void 0!==a.selector&&(b=d(a.selector)),Object.keys(b).length&&MaskEventBroker.subscribe("initialization",function(){var a,d;for(a in b)if(b.hasOwnProperty(a)&&(d=b[a])){var e=generalMaskedFn.extend(generalMaskedFn.extend(generalMaskedFn.extend({},c),d.dataset),d.value?{phone:d.value}:{});d.value=e.phone,generalMaskedFn.addLanguage(e.language),MaskEvents.onInitialized(function(){MaskEventBroker.publish("load.all.masks.lists")}),MaskEventBroker.subscribe("load.all.masks.lists",function(){k.loadMask("all",Global.languages,function(){MaskEvents.events.maskListLoaded=!0})}),MaskEvents.onMaskListLoaded(function(){MaskEventBroker.publish("create.mask.objects"),MaskEvents.events.createdMaskObjects=!0}),MaskEventBroker.subscribe("create.mask.objects",function(){new l(d,e)})}}),e}},m}(document,window);