var CBHMasks=function(){function a(a,b){var c=new RegExp("(^|\\s)"+b+"(\\s|$)","g");c.test(a.className)||(a.className=(a.className+" "+b).replace(/\s+/g," ").replace(/(^ | $)/g,""))}function b(a,b){var c=new RegExp("(^|\\s)"+b+"(\\s|$)","g");a.className=a.className.replace(c,"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}function c(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;8>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}var d="undefined",e=function(){function a(a){if(a=a||window.event,a.isFixed)return a;if(a.isFixed=!0,a.preventDefault=a.preventDefault||function(){this.returnValue=!1},a.stopPropagation=a.stopPropagaton||function(){this.cancelBubble=!0},a.target||(a.target=a.srcElement),!a.relatedTarget&&a.fromElement&&(a.relatedTarget=a.fromElement==a.target?a.toElement:a.fromElement),null==a.pageX&&null!=a.clientX){var b=document.documentElement,c=document.body;a.pageX=a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b.clientLeft||0),a.pageY=a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b.clientTop||0)}return!a.which&&a.button&&(a.which=1&a.button?1:2&a.button?3:4&a.button?2:0),a}function b(b){b=a(b);var c=this.events[b.type];for(var d in c){var e=c[d],f=e.call(this,b);f===!1&&(b.preventDefault(),b.stopPropagation())}}var c=0;return{add:function(a,d,f){a.setInterval&&a!=window&&!a.frameElement&&(a=window),f.guid||(f.guid=++c),a.events||(a.events={},a.handle=function(c){return"undefined"!=typeof e?b.call(a,c):void 0}),a.events[d]||(a.events[d]={},a.addEventListener?a.addEventListener(d,a.handle,!1):a.attachEvent&&a.attachEvent("on"+d,a.handle)),a.events[d][f.guid]=f},remove:function(a,b,c){var d=a.events&&a.events[b];if(d){delete d[c.guid];for(var e in d)return;a.removeEventListener?a.removeEventListener(b,a.handle,!1):a.detachEvent&&a.detachEvent("on"+b,a.handle),delete a.events[b];for(var e in a.events)return;try{delete a.handle,delete a.events}catch(f){a.removeAttribute("handle"),a.removeAttribute("events")}}}}}();$AJAX=function(a){var b=["GET","POST","PUT"],c=["json","text"],e={},f={url:a.url||!1,async:a.async||!1,data:a.data||null,crossDomain:a.crossDomain||!1,complete:a.result||function(){},timeout:a.timeout||1e4,type:(-1!==b.indexOf(a.type)?a.type:null)||"GET",dataType:(-1!==c.indexOf(a.dataType)?a.dataType:null)||"json"};if(typeof f.url!==d&&f.url!==!1){typeof XMLHttpRequest==d&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(a){}throw new Error("This browser does not support XMLHttpRequest.")});var g=new("onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest),h=f.url;"GET"===f.type&&f.data&&f.data.length>0&&(h=f.url+"?"+f.data.toString()),g.open(f.type,h,f.async),f.crossDomain||(e["X-Requested-With"]="XMLHttpRequest");for(i in e)void 0!==e[i]&&g.setRequestHeader(i,e[i]+"");f.data&&f.data.toString().length>0&&(g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.data=f.data.toString());try{g.send(f.data||null)}catch(j){}if(f.async)var k=setTimeout(function(){g.abort()},f.timeout);callback=function(){var a,b,c={};if(4===g.readyState)if(f.async&&clearTimeout(k),callback=void 0,4!==g.readyState)g.abort();else{a=g.status,"string"==typeof g.responseText&&(c.text=g.responseText);try{b=g.statusText}catch(d){b=""}a||f.crossDomain?1223===a&&(a=204):a=c.text?200:404}if(c&&(a||f.crossDomain?1223===a&&(a=204):a=c.text?200:404,200===a)){if("text"===f.dataType)var e=c.text||"";else if("json"===f.dataType)var e=JSON.parse(c.text)||"";f.complete(e,a,b,g.getAllResponseHeaders())}},f.async?4===g.readyState?setTimeout(callback):g.onreadystatechange=callback:callback()}};var f={all:[],ru:[],us:[],sortPhones:function(a,b,c){var b="mask"==b?"mask":"name",c="desc"==c?"desc":"asc";return a.sort(function(a,e){if(typeof a[b]!==d&&typeof e[b]!==d){if("mask"===b)var a=a[b].replace(/\D+/g,""),e=e[b].replace(/\D+/g,"");else var a=a[b],e=e[b];return a>e?"asc"==c?1:-1:e>a?"asc"==c?-1:1:0}}),a}},g={focus:function(){j.selectInstance(this).focused()},click:function(){j.selectInstance(this).focused()},keypress:function(a){var b=this,c=j,d=c.regex,e=c.selectInstance(b),f=a.keyCode,g=parseInt(a.key);if(8===f){var h=e.getLastNum(b);return d.test(b.value[h])===!0?(e.removeChar(b,h),e.setCaret(b,h,h),!1):!1}var i=b.value.indexOf("_");return-1===i?!1:d.test(g)!==!0?!1:void e.setCaret(b,i,i+1)},keyup:function(a){var b=this,c=j,d=c.regex,e=c.selectInstance(b),f=a.keyCode;if(8===f){var g=e.getLastNum(b);return d.test(b.value[g])===!0?(g+=1,e.setCaret(b,g,g),!1):!1}if(13===a.which||13===a.keyCode)e.opt.onsend&&e.opt.onsend(e.opt);else{var h=b.value.indexOf("_"),g=-1!==h?h:b.value.length;e.setCaret(b,g,g),e.setCheckedMask(b)}}},h=function(b,d){if(d.phone){var e=this.maskFinder(f.all,d.phone);e&&(d.mask=this.setNewMaskValue(d.phone,e.mask),d.country=e.obj.iso_code)}this.opt={instId:j.prefix+c(),element:b,lang:d.lang||"ru",country:d.country||"ru",phone:d.phone||!1,mask:d.mask||"",onsend:d.onsend||null,value:"",old:{}},this.setTemplate();var g=this.opt,h=g.mask;element=this.opt.element,element.value=h,element.placeholder=h,a(element,g.instId),this.addActions(g.element)};h.prototype={setTemplate:function(){var c=this.opt,g=this.opt.element,h=j,i=function(a){return document.createElement(a)},k=function(a,b){a.innerHTML=b.outerHTML},l=function(a,b){return a.className=b},m=f,n=function(a,b){a.appendChild(b)},o=i("div");k(o,g),l(o,"CBH-masks"),g.parentNode.replaceChild(o,g);var p=i("i");l(p,"caret");var q=i("div");k(q,p),l(q,"flag "+c.country);var r=i("div");k(r,q),l(r,"selected");var s=i("div");k(s,r),l(s,"flags");var t=i("ul");l(t,"lists");var u=m.sortPhones(m.all,"name","asc");for(A in u){var v=u[A],w=v.iso_code.toString().toLowerCase(),x=v.name,y=v.mask;if(typeof x!==d){c.phone===!1&&c.country===w&&(this.opt.mask=y);var z=i("li");z.className="country",z.dataset.isoCode=w,z.dataset.mask=y,e.add(z,"click",this.maskReplace);var A=i("i");l(A,"flag "+w),n(z,A);var B=i("span");l(B,"name"),B.innerHTML=x,n(z,B);var B=i("span");l(B,"code"),B.innerHTML="+"+v.phone_code,n(z,B),n(t,z)}}n(s,t),e.add(t,"mousedown",function(a){a.stopPropagation()}),o.insertBefore(s,o.firstChild),o.getElementsByClassName("selected")[0].onclick=function(){var c=document.getElementsByClassName("lists active"),d=o.getElementsByClassName("lists")[0];if(c.length)for(var e in c)d!==c[e]&&c.hasOwnProperty(e)&&b(c[e],"active");if(/active/.test(d.className)!==!0){a(d,"active");var f=window,g=document,i=f.innerHeight||g.documentElement.clientHeight||g.body.clientHeight,j=h.findPos(d),k=j.top-d.scrollTop,l=d.clientHeight;i-(k+o.childNodes[1].clientHeight)<=l&&a(d,"top")}else b(d,"active"),b(d,"top")},this.opt.element=o.childNodes[1]},maskReplace:function(){var a=this,c=a.parentNode.parentNode,d=c.parentNode.childNodes[1],e=j,f=j.selectInstance(d),g=a.dataset,h=d.placeholder,i={code:g.isoCode,mask:g.mask,phone_code:f.getVal(g.mask)},k={mask:h,phone_code:f.getVal(h),val:f.getVal(d.value)},l=k.val.replace(k.phone_code,i.phone_code),m=k.mask.replace(new RegExp([e.regex.source].concat("_").join("|"),"g"),"_");d.value=f.setNewMaskValue(l,m),d.placeholder=i.mask,flag_el=c.childNodes[0].childNodes[0],flag_el.className="flag "+i.code,list_el=c.childNodes[1],b(list_el,"active")},addActions:function(a){e.add(a,"focus",g.focus),e.add(a,"click",g.click),e.add(a,"keypress",g.keypress),e.add(a,"keyup",g.keyup)},focused:function(){var a=this.opt.element,b=a.value,c=b.indexOf("_"),d=-1===c?b.length:c;this.setCaret(a,d,d)},setCaret:function(a,b,c){if(a.focus(),a.setSelectionRange)a.setSelectionRange(b,c);else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",b),d.moveStart("character",c),d.select()}},getLastNum:function(a){for(var b=a.value,c=b.length;c>=0&&!j.regex.test(b[c]);c--);return c},removeChar:function(a,b){var c=a.value.split("");c[b]="_",a.value=c.join("")},setCheckedMask:function(a){var b=this.getVal(a.value),c=f,d=this.maskFinder(c.all,b),e=this.opt.old;if(d!==!1){var b=this.getVal(a.value),d=this.maskFinder(f.all,b),e=this.opt.old;if(d!==!1){if("undefined"!=typeof f[d.obj.iso_code]&&0===f[d.obj.iso_code].length&&j.loadMasks(this.opt.country,this.opt.lang),"undefined"!=typeof this.opt.country&&"null"!=typeof e){var g=this.maskFinder(f[d.obj.iso_code],b);g&&(d=g)}if("undefined"==typeof d.obj.name&&e.obj!=d.obj){var h=d.obj.iso_code,i=this.findMaskByCode(h);i&&(d.obj.name=i.name)}!d||e.obj==d.obj&&e.determined==d.determined||(this.opt.old=d,a.value=this.setNewMaskValue(b,d.mask),this.setInputAttrs(a,d.obj.iso_code,d.obj.name),this.focused(a))}}},getVal:function(a){return a.replace(/\D+/g,"")},maskFinder:function(a,b){var c=[],d=j.regex;for(var e in a){for(var f=a[e].mask,g=!0,h=0,i=0;h<b.length&&i<f.length;){var k=f.charAt(i),l=b.charAt(h);if(d.test(k)||"_"===k){if(!("_"===k&&d.test(l)||l==k)){g=!1;break}h++,i++}else i++}if(g&&h==b.length){var m=-1==f.substr(i).search(d);f=f.replace(new RegExp([d.source].concat("_").join("|"),"g"),"_"),c.push({mask:f,obj:a[e],determined:m})}}var n=!1;for(var o in c){var p=this.getVal(c[o].obj.mask);parseInt(p)===parseInt(b)&&(n=c[o])}return n||c[0]||!1},findMaskByCode:function(a){var b=f,c=b.sortPhones(b.all,"name");for(i in b.all){var d=c[i];if(c[i].iso_code===a)return d}return!1},setNewMaskValue:function(a,b){var a=this.getVal(a),b=b.split(""),c=0;for(i in b){var d=b[i];"_"==d&&c<a.length&&(b[i]=a[c],c++)}return b.join("")},setInputAttrs:function(a,b,c){var d=a.parentNode.getElementsByClassName("selected")[0].getElementsByClassName("flag")[0];d.className="flag "+b,d.parentNode.setAttribute("title",c),this.opt.country=b}};var j={path:"//test.proj/codes/",prefix:"instId_",regex:new RegExp(/[0-9]/),instances:[],init:function(a,b){var c=[],d=document;if("string"==typeof a){var e=a[0];if(("."===e||"#"===e)&&(a=a.substr(1)),"."===e){var f=d.getElementsByClassName(a);if(null!==f)var c=f}else{if("#"!==e)return;var f=d.getElementById(a);null!==f&&c.push(f)}}else a.nodeType&&null!==a&&c.push(a);for(i in c)c.hasOwnProperty(i)&&this.preload(c[i],b)},preload:function(a,b){var c=this,d=c.extend(c.extend({},b),a.dataset);0===f.all.length&&c.loadMasks("all",d.lang);var e=new h(a,d);c.instances[e.opt.instId]=e},loadMasks:function(a,b){$AJAX({url:this.path+a+"/"+(b||"ru")+".json",type:"GET",async:!1,crossDomain:!0,dataType:"json",result:function(b){"all"===a?f[a]=f.sortPhones(b,"mask","desc"):f[a]=f.sortPhones(b,"mask","desc")}})},selectInstance:function(a){return j.instances[a.className.match(new RegExp(/instId_[0-9a-zA-Z]+/))]},extend:function(a,b){var c,d={},e=Object.prototype.hasOwnProperty;for(c in a)e.call(a,c)&&(d[c]=a[c]);for(c in b)e.call(b,c)&&(d[c]=b[c]);return d},findPos:function(a){var b=curtop=0;if(a&&a.offsetParent)do b+=a.offsetLeft,curtop+=a.offsetTop;while(a=a.offsetParent);return{left:b,top:curtop}},phoneCodes:f};return j}();