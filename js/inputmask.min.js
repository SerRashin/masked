var CBHMasks=function(){function a(a,b){var c=new RegExp("(^|\\s)"+b+"(\\s|$)","g");c.test(a.className)||(a.className=(a.className+" "+b).replace(/\s+/g," ").replace(/(^ | $)/g,""))}function b(a,b){var c=new RegExp("(^|\\s)"+b+"(\\s|$)","g");a.className=a.className.replace(c,"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}function c(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;8>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}var d=function(){function a(a){if(a=a||window.event,a.isFixed)return a;if(a.isFixed=!0,a.preventDefault=a.preventDefault||function(){this.returnValue=!1},a.stopPropagation=a.stopPropagaton||function(){this.cancelBubble=!0},a.target||(a.target=a.srcElement),!a.relatedTarget&&a.fromElement&&(a.relatedTarget=a.fromElement==a.target?a.toElement:a.fromElement),null==a.pageX&&null!=a.clientX){var b=document.documentElement,c=document.body;a.pageX=a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b.clientLeft||0),a.pageY=a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b.clientTop||0)}return!a.which&&a.button&&(a.which=1&a.button?1:2&a.button?3:4&a.button?2:0),a}function b(b){b=a(b);var c=this.events[b.type];for(var d in c){var e=c[d],f=e.call(this,b);f===!1&&(b.preventDefault(),b.stopPropagation())}}var c=0;return{add:function(a,e,f){a.setInterval&&a!=window&&!a.frameElement&&(a=window),f.guid||(f.guid=++c),a.events||(a.events={},a.handle=function(c){return"undefined"!=typeof d?b.call(a,c):void 0}),a.events[e]||(a.events[e]={},a.addEventListener?a.addEventListener(e,a.handle,!1):a.attachEvent&&a.attachEvent("on"+e,a.handle)),a.events[e][f.guid]=f},remove:function(a,b,c){var d=a.events&&a.events[b];if(d){delete d[c.guid];for(var e in d)return;a.removeEventListener?a.removeEventListener(b,a.handle,!1):a.detachEvent&&a.detachEvent("on"+b,a.handle),delete a.events[b];for(var e in a.events)return;try{delete a.handle,delete a.events}catch(f){a.removeAttribute("handle"),a.removeAttribute("events")}}}}}();$.AJAX=function(a){var b=["GET","POST","PUT"],c=["json","text"],d={},e={url:a.url||!1,async:a.async||!1,data:a.data||null,crossDomain:a.crossDomain||!1,complete:a.result||function(){},timeout:a.timeout||1e4,type:(-1!==b.indexOf(a.type)?a.type:null)||"GET",dataType:(-1!==c.indexOf(a.dataType)?a.dataType:null)||"json"};if("undefined"!=typeof e.url&&e.url!==!1){"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(a){}throw new Error("This browser does not support XMLHttpRequest.")});var f=new("onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest),g=e.url;"GET"===e.type&&e.data&&e.data.length>0&&(g=e.url+"?"+e.data.toString()),f.open(e.type,g,e.async),e.crossDomain||(d["X-Requested-With"]="XMLHttpRequest");for(i in d)void 0!==d[i]&&f.setRequestHeader(i,d[i]+"");e.data&&e.data.toString().length>0&&(f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.data=e.data.toString());try{f.send(e.data||null)}catch(h){}if(e.async)var j=setTimeout(function(){f.abort()},e.timeout);callback=function(){var a,b,c={};if(4===f.readyState)if(e.async&&clearTimeout(j),callback=void 0,4!==f.readyState)f.abort();else{a=f.status,"string"==typeof f.responseText&&(c.text=f.responseText);try{b=f.statusText}catch(d){b=""}a||e.crossDomain?1223===a&&(a=204):a=c.text?200:404}if(c&&(a||e.crossDomain?1223===a&&(a=204):a=c.text?200:404,200===a)){if("text"===e.dataType)var g=c.text||"";else if("json"===e.dataType)var g=JSON.parse(c.text)||"";e.complete(g,a,b,f.getAllResponseHeaders())}},e.async?4===f.readyState?setTimeout(callback):f.onreadystatechange=callback:callback()}};var e={all:[],ru:[],en:[],sortPhones:function(a){var b="name";return a.sort(function(a,c){if("undefined"!=typeof a[b]&&"undefined"!=typeof c[b])for(var d=0,e=0;d<a[b].length&&e<c[b].length;){var f=a[b].charAt(d),g=c[b].charAt(e);return f>g?1:g>f?-1:0}}),a}},f={focus:function(){h.selectInstance(this).focused()},click:function(){h.selectInstance(this).focused()},keypress:function(a){var b=h.selectInstance(this);if($code=a.keyCode,$key=parseInt(a.key),8===$code){var c=b.getLastNum(this);return h.regex.test(this.value[c])===!0?(b.removeChar(this,c),b.setCaret(this,c,c),!1):!1}var d=this.value.indexOf("_");return-1===d?!1:h.regex.test($key)!==!0?!1:void b.setCaret(this,d,d+1)},keyup:function(a){var b=this,c=h.selectInstance(b);if($code=a.keyCode,8===$code){var d=c.getLastNum(b);return h.regex.test(b.value[d])===!0?(d+=1,c.setCaret(b,d,d),!1):!1}var e=b.value.indexOf("_"),d=-1!==e?e:b.value.length;c.setCaret(b,d,d),c.setCheckedMask(b)}},g=function(b,d){if(d.phone!==!1){var f=this.maskFinder(e.all,d.phone);f&&(d.mask=this.setNewMaskValue(d.phone,f.mask),d.country=f.obj.iso_code)}this.opt={instId:h.prefix+c(),element:b,lang:d.lang||"ru",country:d.country||"ru",phone:d.phone||!1,mask:d.mask||"",value:"",old:{}},console.log(this.opt),this.setTemplate(),this.opt.element.value=this.opt.mask,this.opt.element.placeholder=this.opt.mask,a(this.opt.element,this.opt.instId),this.addActions(this.opt.element)};g.prototype={setTemplate:function(){var c=this.opt,d=this.opt.element,f=document.createElement("div");f.innerHTML=d.outerHTML,f.className="CBH-masks",d.parentNode.replaceChild(f,d);var g=document.createElement("i");g.className="caret";var h=document.createElement("div");h.innerHTML=g.outerHTML,h.className="flag "+c.country;var i=document.createElement("div");i.innerHTML=h.outerHTML,i.className="selected";var j=document.createElement("div");j.innerHTML=i.outerHTML,j.className="flags";var k=document.createElement("ul");k.className="lists";var l=e.sortPhones(e.all);for(o in l){var m=l[o];if(m.iso_code=m.iso_code.toString().toLowerCase(),"undefined"!=typeof m.name){c.phone===!1&&c.country===m.iso_code&&(this.opt.mask=m.mask);var n=document.createElement("li");n.className="country",n.dataset.isoCode=m.iso_code.toString().toLowerCase(),n.dataset.mask=m.mask;var o=document.createElement("i");o.className="flag "+m.iso_code,n.appendChild(o);var p=document.createElement("span");p.className="name",p.innerHTML=m.name,n.appendChild(p);var p=document.createElement("span");p.className="code",p.innerHTML="+"+m.phone_code,n.appendChild(p),k.appendChild(n)}}j.appendChild(k),f.insertBefore(j,f.firstChild),f.getElementsByClassName("selected")[0].onclick=function(){var c=f.getElementsByClassName("lists")[0];/active/.test(c.className)===!0?b(c,"active"):a(c,"active")},this.opt.element=f.childNodes[1]},addActions:function(a){d.add(a,"focus",f.focus),d.add(a,"click",f.click),d.add(a,"keypress",f.keypress),d.add(a,"keyup",f.keyup)},focused:function(){var a=this.opt.element,b=a.value.indexOf("_"),c=-1===b?a.value.length:b;this.setCaret(a,c,c)},setCaret:function(a,b,c){if(a.focus(),a.setSelectionRange)a.setSelectionRange(b,c);else if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",b),d.moveStart("character",c),d.select()}},getLastNum:function(a){for(var b=a.value.length;b>=0&&!h.regex.test(a.value[b]);b--);return b},removeChar:function(a,b){var c=a.value.split("");c[b]="_",a.value=c.join("")},setCheckedMask:function(a){var b=this.getVal(a.value),c=this.maskFinder(e.all,b),d=this.opt.old;if(c!==!1){if("undefined"!=typeof e[c.obj.iso_code]&&0===e[c.obj.iso_code].length&&h.loadMasks(this.opt.country,this.opt.lang),"undefined"!=typeof this.opt.country&&"null"!=typeof d){var f=this.maskFinder(e[c.obj.iso_code],b);f&&(c=f)}if("undefined"==typeof c.obj.name&&d.obj!=c.obj){var g=c.obj.iso_code,i=this.findMaskByCode(g);i&&(c.obj.name=i.name)}!c||d.obj==c.obj&&d.determined==c.determined||(this.opt.old=c,a.value=this.setNewMaskValue(b,c.mask),this.setInputAttrs(a,c.obj.iso_code,c.obj.name),this.focused(a))}},getVal:function(a){return a.replace(/\D+/g,"")},maskFinder:function(a,b){var c=[];for(var d in a){for(var e=a[d].mask,f=!0,g=0,i=0;g<b.length&&i<e.length;){var j=e.charAt(i),k=b.charAt(g);if(h.regex.test(j)||"_"===j){if(!("_"===j&&h.regex.test(k)||k==j)){f=!1;break}g++,i++}else i++}if(f&&g==b.length){var l=-1==e.substr(i).search(h.regex);e=e.replace(new RegExp([h.regex.source].concat("_").join("|"),"g"),"_"),c.push({mask:e,obj:a[d],determined:l})}}var m=!1;for(var n in c){var o=this.getVal(c[n].obj.mask);parseInt(o)===parseInt(b)&&(m=c[n])}return m||c[0]||!1},findMaskByCode:function(a){var b=e.sortPhones(e.all);for(i in b){var c=b[i];if(b[i].iso_code===a)return c}return!1},setNewMaskValue:function(a,b){var a=this.getVal(a),b=b.split(""),c=0;for(i in b){var d=b[i];"_"==d&&c<a.length&&(b[i]=a[c],c++)}return b.join("")},setInputAttrs:function(a,b,c){var d=a.parentNode.getElementsByClassName("selected")[0].getElementsByClassName("flag")[0];d.className="flag "+b,d.parentNode.setAttribute("title",c),this.opt.country=b}};var h={path:"//test.proj/codes/",prefix:"instId_",regex:new RegExp(/[0-9]/),instances:[],init:function(a,b){var c=[];if("string"==typeof a){var d=a[0];if(("."===d||"#"===d)&&(a=a.substr(1)),"."===d)var c=document.getElementsByClassName(a);else{if("#"!==d)return;c.push(document.getElementById(a))}}else a.nodeType&&c.push(a);for(i in c)c.hasOwnProperty(i)&&this.preload(c[i],b)},preload:function(a,b){var c="undefined",d={lang:a.dataset.lang?a.dataset.lang:typeof b!==c&&b.lang?b.lang:!1,country:a.dataset.country?a.dataset.country:typeof b!==c&&b.country?b.country:!1,phone:a.dataset.phone?a.dataset.phone:typeof b!==c&&b.phone?b.phone:!1};0===e.all.length&&this.loadMasks("all",d.lang);var f=new g(a,d);this.instances[f.opt.instId]=f},loadMasks:function(a,b){$.AJAX({url:this.path+a+"/"+b+".json",type:"GET",async:!1,crossDomain:!0,dataType:"json",result:function(b){e[a]=b}})},selectInstance:function(a){return h.instances[a.className.match(new RegExp(/instId_[0-9a-zA-Z]+/))]}};return h}();