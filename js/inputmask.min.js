var CBHMasks=function(){function a(a,b){var c=a.className;new RegExp("(^|\\s)"+b+"(\\s|$)","g").test(c)||(a.className=(c+" "+b).replace(/\s+/g," ").replace(/(^ | $)/g,""))}function b(a,b){a.className=a.className.replace(new RegExp("(^|\\s)"+b+"(\\s|$)","g"),"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}function c(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;8>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}var d="undefined",e=function(){function a(a){var b=a||d.event;if(b.isFixed)return b;if(b.isFixed=!0,b.preventDefault=b.preventDefault||function(){this.returnValue=!1},b.stopPropagation=b.stopPropagation||function(){this.cancelBubble=!0},b.target||(b.target=b.srcElement),!b.relatedTarget&&b.fromElement&&(b.relatedTarget=b.fromElement==b.target?b.toElement:b.fromElement),null==b.pageX&&null!=b.clientX){var c=f.documentElement,e=f.body;b.pageX=b.clientX+(c&&c.scrollLeft||e&&e.scrollLeft||0)-(c.clientLeft||0),b.pageY=b.clientY+(c&&c.scrollTop||e&&e.scrollTop||0)-(c.clientTop||0)}return!b.which&&b.button&&(b.which=1&b.button?1:2&b.button?3:4&b.button?2:0),b}function b(b){var c,d=a(b),e=this.events[d.type];for(c in e)if(e.hasOwnProperty(c)){var f=e[c],g=f.call(this,d);g===!1&&(d.preventDefault(),d.stopPropagation())}}var c=0,d=window,f=document;return{add:function(a,f,g){a.setInterval&&a!=d&&!a.frameElement&&(a=d),g.guid||(g.guid=++c),a.events||(a.events={},a.handle=function(c){return"undefined"!=typeof e?b.call(a,c):void 0}),a.events[f]||(a.events[f]={},a.addEventListener?a.addEventListener(f,a.handle,!1):a.attachEvent&&a.attachEvent("on"+f,a.handle)),a.events[f][g.guid]=g},remove:function(a,b,c){var d,e=a.events&&a.events[b];if(e){delete e[c.guid];for(d in e)if(e.hasOwnProperty(d))return;a.removeEventListener?a.removeEventListener(b,a.handle,!1):a.detachEvent&&a.detachEvent("on"+b,a.handle),delete a.events[b];for(d in a.events)if(a.events.hasOwnProperty(d))return;try{delete a.handle,delete a.events}catch(f){a.removeAttribute("handle"),a.removeAttribute("events")}}}}}();$AJAX=function(a){var b,c,e,f,g,h,i,j={},k=["GET","POST","PUT"],l=["json","text"],m={},n=XMLHttpRequest,o="Msxml2.XMLHTTP",p={url:a.url||!1,async:a.async||!1,data:a.data||null,crossDomain:a.crossDomain||!1,complete:a.result||function(){},timeout:a.timeout||1e4,type:(-1!==k.indexOf(a.type)?a.type:null)||"GET",dataType:(-1!==l.indexOf(a.dataType)?a.dataType:null)||"json"};if(typeof p.url!==d&&p.url!==!1){typeof n==d&&(n=function(){try{var a=ActiveXObject}catch(b){}try{return new a(o+".6.0")}catch(b){}try{return new a(o+".3.0")}catch(b){}try{return new a(o)}catch(b){}throw new Error("This browser does not support XMLHttpRequest.")}),f=new("onload"in new n?n:XDomainRequest),e=p.url,"GET"===p.type&&p.data&&p.data.length>0&&(e=p.url+"?"+p.data.toString()),f.open(p.type,e,p.async),p.crossDomain||(m["X-Requested-With"]="XMLHttpRequest");for(b in m)m.hasOwnProperty(b)&&"undefined"!=typeof m[b]&&f.setRequestHeader(b,m[b]+"");p.data&&p.data.toString().length>0&&(f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),p.data=p.data.toString());try{f.send(p.data||null)}catch(q){}if(p.async)var r=setTimeout(function(){f.abort()},p.timeout);i=function(){if(4===f.readyState)if(p.async&&clearTimeout(r),i="undefined",4!==f.readyState)f.abort();else{g=f.status,"string"==typeof f.responseText&&(j.text=f.responseText);try{h=f.statusText}catch(a){h=""}g||p.crossDomain?1223===g&&(g=204):g=j.text?200:404}j&&(g||p.crossDomain?1223===g&&(g=204):g=j.text?200:404,200===g&&("text"===p.dataType?c=j.text||"":"json"===p.dataType&&(c=JSON.parse(j.text)||""),p.complete(c,g,h,f.getAllResponseHeaders())))},p.async?4===f.readyState?setTimeout(i):f.onreadystatechange=i:i()}};var f={all:[],ru:[],us:[],ca:[],sortPhones:function(a,b,c){var e="mask",f="desc",g="asc",h=b==e?e:"name",i=c==f?f:g;return a.sort(function(a,b){return typeof a[h]!==d&&typeof b[h]!==d?(h===e?(a=a[h].replace(/\D+/g,""),b=b[h].replace(/\D+/g,"")):(a=a[h],b=b[h]),a>b?i==g?1:-1:b>a?i==g?-1:1:0):void 0}),a}},g={focus:function(){j.selectInstance(this).focused()},click:function(){j.selectInstance(this).focused()},keydown:function(a){var b,c,d=this,e=j,f=e.regex,g=e.selectInstance(d),h=a.which||a.keyCode,i=a.key?a.key:h>=96&&105>=h?String.fromCharCode(h-48):String.fromCharCode(h),k=d.value,l=g.setCaret,m=!1,n=!0;return 8===h?(b=g.getLastNum(d),f.test(k[b])===n?(g.removeChar(d,b),l(d,b,b),m):m):(c=k.indexOf("_"),-1===c?m:f.test(i)!==n?m:void l(d,c,c+1))},keyup:function(a){var b,c,d=this,e=j,f=e.regex,g=e.selectInstance(d),h=a.keyCode||a.which,i=d.value,k=g.opt,l=g.setCaret,m=!1;return 8===h?(b=g.getLastNum(d),f.test(i[b])===!0?(b+=1,l(d,b,b),m):m):void(13===h?k.onsend&&k.onsend(k):(c=i.indexOf("_"),b=-1!==c?c:i.length,l(d,b,b),g.setCheckedMask(d)))}},h=function(a,b){this.opt={instId:j.prefix+c(),element:a,lang:b.lang||"ru",country:b.country||"ru",phone:b.phone||!1,mask:b.mask||"",onsend:b.onsend||null,value:"",name:"",old:{}},this.init(a,this.opt)};h.prototype={init:function(b,c){var d,e,g,h=this,i=j;if(c.phone){var k,l,m,n=h.getVal(c.phone+""),o=n.length,p=f,q=h.maskFinder(p.all,o>6?n.substring(0,6):n);if(q){if(l=q.obj.iso_code,"undefined"!=typeof p[l]&&0===p[l].length)return i.loadMasks(l,c.lang,function(){for(k in n)if(n.hasOwnProperty(k)){if(m=h.maskFinder(p[l],n),m&&n!==q.obj.phone_code){c.mask=h.setNewMaskValue(n,m.mask),c.country=m.obj.iso_code,c.phone=n;break}n=n.substring(0,o-1)}return h.init(b,c),!0}),!0;c.mask=h.setNewMaskValue(n,q.mask),c.country=q.obj.iso_code}}i.loaded=!0,h.opt=i.extend(h.opt,c),h.setTemplate(),g=h.opt,d=g.mask,e=h.opt.element,e.value=d,e.placeholder=d,a(e,g.instId),h.addActions(g.element)},setTemplate:function(){var c,g,h,i,k,l,m,n,o,p,q,r,s=this,t=window,u=document,v=s.opt,w=v.element,x=j,y="lists",z="active",A="top",B=u.getElementsByClassName(y+" "+z),C=function(a){return document.createElement(a)},D=function(a,b){a.innerHTML=b.outerHTML},E=function(a,b){return a.className=b},F=f,G=function(a,b){a.appendChild(b)},H="div",I="flag";if(o=C("div"),D(o,w),E(o,"CBH-masks"),w.parentNode.replaceChild(o,w),m=C("i"),E(m,"caret"),l=C(H),D(l,m),E(l,I+" "+v.country),p=C(H),D(p,l),E(p,"selected"),q=C(H),D(q,p),E(q,"flags"),h=C("ul"),E(h,"lists"),r=F.sortPhones(F.all,"name","asc"),0!==r.length){for(c in r)if(r.hasOwnProperty(c)){var J=r[c],K=J.iso_code.toString().toLowerCase(),L=J.name,M=J.mask;if(typeof L===d)continue;v.phone===!1&&v.country===K&&(s.opt.name=L,s.opt.mask=M),g=C("li"),g.className="country",g.dataset.isoCode=K,g.dataset.mask=M,e.add(g,"click",s.maskReplace),i=C("i"),E(i,I+" "+K),G(g,i),k=C("span"),E(k,"name"),k.innerHTML=L,G(g,k),k=C("span"),E(k,"code"),k.innerHTML="+"+J.phone_code,G(g,k),G(h,g)}G(q,h),e.add(h,"mousedown",function(a){a.stopPropagation()}),o.insertBefore(q,o.firstChild),o.getElementsByClassName("selected")[0].onclick=function(){if(n=o.getElementsByClassName(y)[0],B.length)for(c in B)B.hasOwnProperty(c)&&n!==B[c]&&b(B[c],z);if(/active/.test(n.className)!==!0){a(n,z);var d=t.innerHeight||u.documentElement.clientHeight||u.body.clientHeight,e=x.findPos(n),f=e.top-n.scrollTop,g=n.clientHeight;d-(f+o.childNodes[1].clientHeight)<=g&&a(n,A)}else b(n,z),b(n,A)},s.opt.element=o.childNodes[1]}},maskReplace:function(){var a,c,d=this,e=d.parentNode.parentNode,f=e.parentNode.childNodes[1],g=j,h=g.selectInstance(f),i=d.dataset,k=h.findMaskByCode(h.opt.country),l=h.findMaskByCode(i.isoCode);f.value=h.setNewMaskValue(h.getVal(f.value).replace(k.phone_code,l.phone_code),h.opt.mask.replace(new RegExp([g.regex.source].concat("_").join("|"),"g"),"_")),f.placeholder=l.mask,h.opt.value=f.value,h.opt.name=l.name,h.opt.mask=l.mask,h.opt.country=l.iso_code,a=e.childNodes[0].childNodes[0],a.className="flag "+l.iso_code,c=e.childNodes[1],b(c,"active")},addActions:function(a){e.add(a,"focus",g.focus),e.add(a,"click",g.click),e.add(a,"keydown",g.keydown),e.add(a,"keyup",g.keyup)},focused:function(){var a=this,b=a.opt.element,c=b.value,d=c.indexOf("_"),e=-1===d?c.length:d;a.setCaret(b,e,e)},setCaret:function(a,b,c){var d="character";if(a.focus(),a.setSelectionRange)a.setSelectionRange(b,c);else if(a.createTextRange){var e=a.createTextRange();e.collapse(!0),e.moveEnd(d,b),e.moveStart(d,c),e.select()}},getLastNum:function(a){var b,c=a.value;for(b=c.length;b>=0&&!j.regex.test(c[b]);b--);return b},removeChar:function(a,b){var c=a.value.split("");c[b]="_",a.value=c.join("")},setCheckedMask:function(a){var b,c,e,g=this,h=g.getVal(a.value),i=f,k=g.maskFinder(i.all,h),l=g.opt.old;k!==!1&&(h.length&&typeof i[k.obj.iso_code]!==d&&0===i[k.obj.iso_code].length&&j.loadMasks(k.obj.iso_code,g.opt.lang),typeof i[k.obj.iso_code]!==d&&"null"!=typeof l&&(e=g.maskFinder(i[k.obj.iso_code],h),e&&(k=e)),typeof k.obj.name===d&&l.obj!=k.obj&&(b=k.obj.iso_code,c=g.findMaskByCode(b),c&&(k.obj.name=c.name)),!k||l.obj==k.obj&&l.determined==k.determined||(g.opt.old=k,g.setInputAttrs(a,k.obj.iso_code,k.obj.name,g.setNewMaskValue(h,k.mask)),g.focused(a)))},getVal:function(a){return a.replace(/\D+/g,"")},maskFinder:function(a,b){var c,d,e,f,g,h,i,k,l=[],m=this,n=j.regex;for(c in a)if(a.hasOwnProperty(c)){for(h=a[c].mask,i=!0,d=0,e=0;d<b.length&&e<h.length;){var o=h.charAt(e),p=b.charAt(d);if(n.test(o)||"_"===o){if(!("_"===o&&n.test(p)||p==o)){i=!1;break}d++,e++}else e++}i&&d==b.length&&(k=-1==h.substr(e).search(n),h=h.replace(new RegExp([n.source].concat("_").join("|"),"g"),"_"),l.push({mask:h,obj:a[c],determined:k}))}g=!1;for(c in l)l.hasOwnProperty(c)&&(f=m.getVal(l[c].obj.mask),parseInt(f)===parseInt(b)&&(g=l[c]));return g||l[0]||!1},findMaskByCode:function(a){var b,c,d=f,e=d.sortPhones(d.all,"name",1);for(b in d.all)if(d.all.hasOwnProperty(b)&&(c=e[b],c.iso_code===a))return c;return!1},setNewMaskValue:function(a,b){var c,d,e=this.getVal(a),f=b.split(""),g=0;for(c in f)f.hasOwnProperty(c)&&(d=f[c],"_"==d&&g<e.length&&(f[c]=e[g],g++));return f.join("")},setInputAttrs:function(a,b,c,d){a.value=d;var e=this.opt,f=a.parentNode.getElementsByClassName("selected")[0].getElementsByClassName("flag")[0];f.className="flag "+b,f.parentNode.setAttribute("title",c),e.country=b,e.name=c,e.value=d}};var i={path:"//test.proj/js/masks/",prefix:"instId_"},j={path:i.path,prefix:i.prefix,regex:new RegExp("[0-9]"),instances:[],loaded:!0,init:function(a,b){var c,d,e,f,g=[],h=this,i=document;if("string"==typeof a)if(d=a[0],("."===d||"#"===d)&&(a=a.substr(1)),"."===d){f=i.getElementsByClassName(a);for(c in f)f.hasOwnProperty(c)&&null!==f[c]&&(g[f[c].id||c]=f[c])}else{if("#"!==d)return;f=i.getElementById(a),null!==f&&g.push(f)}else a.nodeType&&null!==a&&g.push(a);h.loaded===!1?e=setInterval(function(){h.loaded===!0&&(h.loop(g,b),clearInterval(e))},10):h.loop(g,b)},loop:function(a,b){var c,d,e,g=this;for(c in a)if(a.hasOwnProperty(c)){if(d=a[c],e=g.extend(g.extend({},b),d.dataset),0===f.all.length){g.loaded=!1,g.loadMasks("all",e,function(b){g.loop(a,b)});break}g.preload(d,e)}},preload:function(a,b){var c=this,d=new h(a,b);c.instances[d.opt.instId]=d},loadMasks:function(a,b,c){var d=this,e=f,g=!0;$AJAX({url:d.path+a+"/"+("ru"==b.lang?"ru":"en")+".min.json",type:"GET",async:g,crossDomain:g,dataType:"json",result:function(d){e[a]=e.sortPhones(d,"mask","desc"),"function"==typeof c&&c(b)}})},selectInstance:function(a){var b=j;return b.instances[a.className.match(new RegExp(b.prefix+"[0-9a-zA-Z]+"))]},extend:function(a,b){var c,d={},e=Object.prototype.hasOwnProperty;for(c in a)a.hasOwnProperty(c)&&e.call(a,c)&&(d[c]=a[c]);for(c in b)b.hasOwnProperty(c)&&e.call(b,c)&&(d[c]=b[c]);return d},findPos:function(a){var b=0,c=0;if(a&&a.offsetParent)do b+=a.offsetLeft,c+=a.offsetTop;while(a=a.offsetParent);return{left:b,top:c}},getById:function(a){var b=document.getElementById(a);return null!==b?this.selectInstance(b):!1}};return j}();