var CBHMasks=function(){function a(a,b){var c=a.className;new RegExp("(^|\\s)"+b+"(\\s|$)","g").test(c)||(a.className=(c+" "+b).replace(/\s+/g," ").replace(/(^ | $)/g,""))}function b(a,b){a.className=a.className.replace(new RegExp("(^|\\s)"+b+"(\\s|$)","g"),"$1").replace(/\s+/g," ").replace(/(^ | $)/g,"")}function c(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;8>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}var d="undefined",e=function(){function a(a){if(a=a||d.event,a.isFixed)return a;if(a.isFixed=!0,a.preventDefault=a.preventDefault||function(){this.returnValue=!1},a.stopPropagation=a.stopPropagaton||function(){this.cancelBubble=!0},a.target||(a.target=a.srcElement),!a.relatedTarget&&a.fromElement&&(a.relatedTarget=a.fromElement==a.target?a.toElement:a.fromElement),null==a.pageX&&null!=a.clientX){var b=f.documentElement,c=f.body;a.pageX=a.clientX+(b&&b.scrollLeft||c&&c.scrollLeft||0)-(b.clientLeft||0),a.pageY=a.clientY+(b&&b.scrollTop||c&&c.scrollTop||0)-(b.clientTop||0)}return!a.which&&a.button&&(a.which=1&a.button?1:2&a.button?3:4&a.button?2:0),a}function b(b){b=a(b);var c=this.events[b.type];for(var d in c){var e=c[d],f=e.call(this,b);f===!1&&(b.preventDefault(),b.stopPropagation())}}var c=0,d=window,f=document;return{add:function(a,f,g){a.setInterval&&a!=d&&!a.frameElement&&(a=d),g.guid||(g.guid=++c),a.events||(a.events={},a.handle=function(c){return"undefined"!=typeof e?b.call(a,c):void 0}),a.events[f]||(a.events[f]={},a.addEventListener?a.addEventListener(f,a.handle,!1):a.attachEvent&&a.attachEvent("on"+f,a.handle)),a.events[f][g.guid]=g},remove:function(a,b,c){var d=a.events&&a.events[b];if(d){delete d[c.guid];for(var e in d)return;a.removeEventListener?a.removeEventListener(b,a.handle,!1):a.detachEvent&&a.detachEvent("on"+b,a.handle),delete a.events[b];for(var e in a.events)return;try{delete a.handle,delete a.events}catch(f){a.removeAttribute("handle"),a.removeAttribute("events")}}}}}();$AJAX=function(a){var b=["GET","POST","PUT"],c=["json","text"],e={},f=XMLHttpRequest,g="Msxml2.XMLHTTP",h={url:a.url||!1,async:a.async||!1,data:a.data||null,crossDomain:a.crossDomain||!1,complete:a.result||function(){},timeout:a.timeout||1e4,type:(-1!==b.indexOf(a.type)?a.type:null)||"GET",dataType:(-1!==c.indexOf(a.dataType)?a.dataType:null)||"json"};if(typeof h.url!==d&&h.url!==!1){typeof f==d&&(f=function(){try{var a=ActiveXObject}catch(b){}try{return new a(g+".6.0")}catch(b){}try{return new a(g+".3.0")}catch(b){}try{return new a(g)}catch(b){}throw new Error("This browser does not support XMLHttpRequest.")});var j=new("onload"in new f?f:XDomainRequest),k=h.url;"GET"===h.type&&h.data&&h.data.length>0&&(k=h.url+"?"+h.data.toString()),j.open(h.type,k,h.async),h.crossDomain||(e["X-Requested-With"]="XMLHttpRequest");for(i in e)void 0!==e[i]&&j.setRequestHeader(i,e[i]+"");h.data&&h.data.toString().length>0&&(j.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.data=h.data.toString());try{j.send(h.data||null)}catch(l){}if(h.async)var m=setTimeout(function(){j.abort()},h.timeout);callback=function(){var a,b,c={};if(4===j.readyState)if(h.async&&clearTimeout(m),callback=void 0,4!==j.readyState)j.abort();else{a=j.status,"string"==typeof j.responseText&&(c.text=j.responseText);try{b=j.statusText}catch(d){b=""}a||h.crossDomain?1223===a&&(a=204):a=c.text?200:404}if(c&&(a||h.crossDomain?1223===a&&(a=204):a=c.text?200:404,200===a)){if("text"===h.dataType)var e=c.text||"";else if("json"===h.dataType)var e=JSON.parse(c.text)||"";h.complete(e,a,b,j.getAllResponseHeaders())}},h.async?4===j.readyState?setTimeout(callback):j.onreadystatechange=callback:callback()}};var f={all:[],ru:[],us:[],ca:[],sortPhones:function(a,b,c){var e="mask",f="desc",g="asc";return b=b==e?e:"name",c=c==f?f:g,a.sort(function(a,f){if(typeof a[b]!==d&&typeof f[b]!==d){if(b===e)var a=a[b].replace(/\D+/g,""),f=f[b].replace(/\D+/g,"");else var a=a[b],f=f[b];return a>f?c==g?1:-1:f>a?c==g?-1:1:0}}),a}},g={focus:function(){k.selectInstance(this).focused()},click:function(){k.selectInstance(this).focused()},keydown:function(a){var b,c,d=this,e=k,f=e.regex,g=e.selectInstance(d),h=a.which||a.keyCode,i=(a.which||a.keyCode,a.key?a.key:h>=96&&105>=h?String.fromCharCode(h-48):String.fromCharCode(h)),j=d.value,l=g.setCaret,m=!1,n=!0;return 8===h?(b=g.getLastNum(d),f.test(j[b])===n?(g.removeChar(d,b),l(d,b,b),m):m):(c=j.indexOf("_"),-1===c?m:f.test(i)!==n?m:void l(d,c,c+1))},keyup:function(a){var b,c,d=this,e=k,f=e.regex,g=e.selectInstance(d),h=a.keyCode||a.which,i=d.value,j=g.opt,l=g.setCaret,m=!1;return 8===h?(b=g.getLastNum(d),f.test(i[b])===!0?(b+=1,l(d,b,b),m):m):void(13===h?j.onsend&&j.onsend(j):(c=i.indexOf("_"),b=-1!==c?c:i.length,l(d,b,b),g.setCheckedMask(d)))}},h=function(a,b){this.opt={instId:k.prefix+c(),element:a,lang:b.lang||"ru",country:b.country||"ru",phone:b.phone||!1,mask:b.mask||"",onsend:b.onsend||null,value:"",name:"",old:{}};this.opt;this.init(a,b)};h.prototype={init:function(b,c){if(c.phone){var d=c.phone+"",e=this,g=f,h=e.maskFinder(g.all,d.length>6?d.substring(0,6):d);if(h){if(iso=h.obj.iso_code,"undefined"!=typeof g[iso]&&0===g[iso].length)return k.loadMasks(iso,c.lang,function(){for(var a in d){var f=e.maskFinder(g[iso],d);if(f){c.mask=e.setNewMaskValue(d,f.mask),c.country=f.obj.iso_code,c.phone=d;break}d=d.substring(0,d.length-1)}return e.init(b,c),!0}),!0;c.mask=e.setNewMaskValue(d,h.mask),c.country=h.obj.iso_code}}this.opt=k.extend(this.opt,c),this.setTemplate();var i=this.opt,j=i.mask;element=this.opt.element,element.value=j,element.placeholder=j,a(element,i.instId),this.addActions(i.element)},setTemplate:function(){var c=this.opt,g=this.opt.element,h=k,i=function(a){return document.createElement(a)},j=function(a,b){a.innerHTML=b.outerHTML},l=function(a,b){return a.className=b},m=f,n=function(a,b){a.appendChild(b)},o="div",p="flag",q=i("div");j(q,g),l(q,"CBH-masks"),g.parentNode.replaceChild(q,g);var r=i("i");l(r,"caret");var s=i(o);j(s,r),l(s,p+" "+c.country);var t=i(o);j(t,s),l(t,"selected");var u=i(o);j(u,t),l(u,"flags");var v=i("ul");l(v,"lists");var w=m.sortPhones(m.all,"name","asc");if(0!==w.length){for(C in w){var x=w[C],y=x.iso_code.toString().toLowerCase(),z=x.name,A=x.mask;if(typeof z!==d){c.phone===!1&&c.country===y&&(this.opt.name=z,this.opt.mask=A);var B=i("li");B.className="country",B.dataset.isoCode=y,B.dataset.mask=A,e.add(B,"click",this.maskReplace);var C=i("i");l(C,p+" "+y),n(B,C);var D=i("span");l(D,"name"),D.innerHTML=z,n(B,D);var D=i("span");l(D,"code"),D.innerHTML="+"+x.phone_code,n(B,D),n(v,B)}}n(u,v),e.add(v,"mousedown",function(a){a.stopPropagation()}),q.insertBefore(u,q.firstChild),q.getElementsByClassName("selected")[0].onclick=function(){var c=window,d=document,e="lists",f="active",g="top",i=d.getElementsByClassName(e+" "+f),j=q.getElementsByClassName(e)[0];if(i.length)for(var k in i)j!==i[k]&&i.hasOwnProperty(k)&&b(i[k],f);if(/active/.test(j.className)!==!0){a(j,f);var l=c.innerHeight||d.documentElement.clientHeight||d.body.clientHeight,m=h.findPos(j),n=m.top-j.scrollTop,o=j.clientHeight;l-(n+q.childNodes[1].clientHeight)<=o&&a(j,g)}else b(j,f),b(j,g)},this.opt.element=q.childNodes[1]}},maskReplace:function(){var a=this,c=a.parentNode.parentNode,d=c.parentNode.childNodes[1],e=k,f=e.selectInstance(d),g=a.dataset,h=f.findMaskByCode(f.opt.country),i=f.findMaskByCode(g.isoCode);d.value=f.setNewMaskValue(f.getVal(d.value).replace(h.phone_code,i.phone_code),f.opt.mask.replace(new RegExp([e.regex.source].concat("_").join("|"),"g"),"_")),d.placeholder=i.mask,f.opt.value=d.value,f.opt.name=i.name,f.opt.mask=i.mask,f.opt.country=i.iso_code,flag_el=c.childNodes[0].childNodes[0],flag_el.className="flag "+i.iso_code,list_el=c.childNodes[1],b(list_el,"active")},addActions:function(a){e.add(a,"focus",g.focus),e.add(a,"click",g.click),e.add(a,"keydown",g.keydown),e.add(a,"keyup",g.keyup)},focused:function(){var a=this.opt.element,b=a.value,c=b.indexOf("_"),d=-1===c?b.length:c;this.setCaret(a,d,d)},setCaret:function(a,b,c){var d="character";if(a.focus(),a.setSelectionRange)a.setSelectionRange(b,c);else if(a.createTextRange){var e=a.createTextRange();e.collapse(!0),e.moveEnd(d,b),e.moveStart(d,c),e.select()}},getLastNum:function(a){for(var b=a.value,c=b.length;c>=0&&!k.regex.test(b[c]);c--);return c},removeChar:function(a,b){var c=a.value.split("");c[b]="_",a.value=c.join("")},setCheckedMask:function(a){var b=this,c=b.getVal(a.value),e=f,g=b.maskFinder(e.all,c),h=b.opt.old;if(g!==!1){if(c.length&&typeof e[g.obj.iso_code]!==d&&0===e[g.obj.iso_code].length&&k.loadMasks(g.obj.iso_code,b.opt.lang),typeof e[g.obj.iso_code]!==d&&"null"!=typeof h){var i=b.maskFinder(e[g.obj.iso_code],c);i&&(g=i)}if(typeof g.obj.name===d&&h.obj!=g.obj){var j=g.obj.iso_code,l=b.findMaskByCode(j);l&&(g.obj.name=l.name)}!g||h.obj==g.obj&&h.determined==g.determined||(b.opt.old=g,b.setInputAttrs(a,g.obj.iso_code,g.obj.name,b.setNewMaskValue(c,g.mask)),b.focused(a))}},getVal:function(a){return a.replace(/\D+/g,"")},maskFinder:function(a,b){var c=[],d=k.regex;for(var e in a){for(var f=a[e].mask,g=!0,h=0,i=0;h<b.length&&i<f.length;){var j=f.charAt(i),l=b.charAt(h);if(d.test(j)||"_"===j){if(!("_"===j&&d.test(l)||l==j)){g=!1;break}h++,i++}else i++}if(g&&h==b.length){var m=-1==f.substr(i).search(d);f=f.replace(new RegExp([d.source].concat("_").join("|"),"g"),"_"),c.push({mask:f,obj:a[e],determined:m})}}var n=!1;for(var o in c){var p=this.getVal(c[o].obj.mask);parseInt(p)===parseInt(b)&&(n=c[o])}return n||c[0]||!1},findMaskByCode:function(a){var b=f,c=b.sortPhones(b.all,"name");for(i in b.all){var d=c[i];if(c[i].iso_code===a)return d}return!1},setNewMaskValue:function(a,b){var a=this.getVal(a),b=b.split(""),c=0;for(i in b){var d=b[i];"_"==d&&c<a.length&&(b[i]=a[c],c++)}return b.join("")},setInputAttrs:function(a,b,c,d){a.value=d;var e=a.parentNode.getElementsByClassName("selected")[0].getElementsByClassName("flag")[0];e.className="flag "+b,e.parentNode.setAttribute("title",c),this.opt.country=b,this.opt.name=c,this.opt.value=d}};var j={path:"//test.proj/js/masks/",prefix:"instId_"},k={path:j.path,prefix:j.prefix,regex:new RegExp(/[0-9]/),instances:[],loaded:!0,init:function(a,b){var c,d=[],e=this,f=document;if("string"==typeof a){var g=a[0];if(("."===g||"#"===g)&&(a=a.substr(1)),"."===g){c=f.getElementsByClassName(a);for(i in c)c.hasOwnProperty(i)&&null!==c[i]&&(d[c[i].id||i]=c[i])}else{if("#"!==g)return;c=f.getElementById(a),null!==c&&d.push(c)}}else a.nodeType&&null!==a&&d.push(a);if(e.loaded===!1)var h=setInterval(function(){e.loaded===!0&&(e.loop(d,b),clearInterval(h))},10);else e.loop(d,b)},loop:function(a,b){for(i in a)if(a.hasOwnProperty(i)){var c=this,d=a[i],e=c.extend(c.extend({},b),d.dataset);if(0===f.all.length){c.loaded=!1,c.loadMasks("all",e.lang,function(){c.loop(a,e)});break}c.preload(d,e)}},preload:function(a,b){var c=this,d=new h(a,b);c.instances[d.opt.instId]=d,c.loaded=!0},loadMasks:function(a,b,c){$AJAX({url:this.path+a+"/"+(b="ru")+".min.json",type:"GET",async:!0,crossDomain:!0,dataType:"json",result:function(b){f[a]=f.sortPhones(b,"mask","desc"),"function"==typeof c&&c()}})},selectInstance:function(a){return k.instances[a.className.match(new RegExp(/instId_[0-9a-zA-Z]+/))]},extend:function(a,b){var c,d={},e=Object.prototype.hasOwnProperty;for(c in a)e.call(a,c)&&(d[c]=a[c]);for(c in b)e.call(b,c)&&(d[c]=b[c]);return d},findPos:function(a){var b=curtop=0;if(a&&a.offsetParent)do b+=a.offsetLeft,curtop+=a.offsetTop;while(a=a.offsetParent);return{left:b,top:curtop}},getById:function(a){var b=document.getElementById(a);return null!==b?this.selectInstance(b):!1}};return k}();